<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluetooth People Counting Documentation: People counting application with BLE</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Bluetooth People Counting Documentation
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__r_e_a_d_m_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">People counting application with BLE </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md16"></a>
Overview</h1>
<p >This project aims to implement a people counting application that using Silabs development kits integrated with the BLE wireless stack and a VL53L1X distance sensors.</p>
<p >The block diagram of this application is shown in the image below:</p>
<p ><img src="doc/images/overview.png" alt="overview" class="inline"/></p>
<p >More detailed information can be found in the section How it works.</p>
<p >This code example referred to the following code examples. More detailed information can be found here:</p>
<ul>
<li><a href="https://github.com/SiliconLabs/platform_hardware_drivers/tree/master/oled_ssd1306_i2c">OLED SSD1306 driver</a></li>
<li><a href="https://github.com/SiliconLabs/bluetooth_stack_features_staging/tree/master/security">Bluetooth security feature</a></li>
<li><a href="https://github.com/SiliconLabs/platform_hardware_drivers/tree/master/distance_vl53l1x">Distance sensor driver</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
Gecko SDK Suite version</h1>
<p >GSDK v4.0.2</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Hardware Required</h1>
<ul>
<li><a href="https://www.silabs.com/development-tools/wireless/bluetooth/bgm220-explorer-kit">BGM220 Bluetooth Module Explorer Kit</a></li>
<li><a href="https://www.sparkfun.com/products/14532">SparkFun Micro OLED Breakout (Qwiic) board</a></li>
<li><a href="https://www.sparkfun.com/products/14722">SparkFun Distance Sensor Breakout</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md19"></a>
Connections Required</h1>
<p >The hardware connection is shown in the image below:</p>
<p ><img src="doc/images/hardware_connection.jpg" alt="hardware connection" class="inline"/></p>
<p >The I2C connection is make from BGM220 Bluetooth Module Explorer Kit to the Distance Sensor Breakout board and the Micro OLED Breakout by using the qwiic cable.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Setup</h1>
<p >To test this application, you can either import the provided <code>bluetooth_people_counting.sls</code> project file or start with an empty example project as the following:</p>
<ol type="1">
<li>Create a <b>Bluetooth - SoC Empty</b> project for the <b>BGM220 Bluetooth Module Explorer Kit</b> using Simplicity Studio 5.</li>
<li>Copy all attached files in <em>inc</em> and <em>src</em> folders into the project root folder (overwriting existing <a class="el" href="app_8c.html" title="Core application logic.">app.c</a>).</li>
<li>Import the GATT configuration:<ul>
<li>Open the .slcp file in the project.</li>
<li>Select the <b>CONFIGURATION TOOLS</b> tab and open the <b>Bluetooth GATT Configurator</b>.</li>
<li>Find the Import button and import the attached <a href="config/gatt_configuration.btconf">gatt_configuration.btconf</a> file.</li>
<li>Save the GATT configuration (ctrl-s).</li>
</ul>
</li>
<li>Open the .slcp file. Select the SOFTWARE COMPONENTS tab and install the software components:<ul>
<li><p class="startli">Install <b>[Platform] &gt; [Driver] &gt; [I2CSPM]</b> component with add new instance name: <b>qwiic</b>. Set this component to use I2C1 peripheral, SCL to PD02 pin, SDA to PD03 pin.</p>
<p class="startli"><img src="doc/images/i2c_qwiic.png" alt="i2c qwiic" class="inline"/> <img src="doc/images/qwiic_settings.png" alt="i2c qwiic setting" class="inline"/></p>
</li>
<li>Install <b>[Platform] &gt; [IO Stream] &gt; [IO Stream: USART]</b> component with the default instance name: <b>vcom</b>.</li>
<li>Install <b>[Platform] &gt; [Driver] &gt; [Button] &gt; [Simple Button]</b> component with the default instance name: <b>btn0</b>.</li>
<li>Install <b>[Platform] &gt; [Driver] &gt; [LED] &gt; [Simple LED]</b> component with the default instance name: <b>led0</b>.</li>
<li>Install <b>[Services] &gt; [NVM3] &gt; [NVM3 Default Instance]</b> component.</li>
<li>Install <b>[Application] &gt; [Utility] &gt; [Log]</b> component.</li>
</ul>
</li>
<li>Build and flash the project to your device.</li>
</ol>
<h1><a class="anchor" id="autotoc_md21"></a>
How it Works</h1>
<h2><a class="anchor" id="autotoc_md22"></a>
API overview</h2>
<p >A detailed description of each function can be found in <a href="doc/doxygen/html/modules.html">doc/doxygen</a>.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
GATT Configurator</h2>
<p >The application is based on the Bluetooth - SoC Empty example. Since the example already has the Bluetooth GATT server, advertising, and connection mechanisms, only minor changes are required.</p>
<p >The GATT changes were adding a new custom service (Air Quality Monitor) using UUID <code>3a79c933-c922-45c7-b5e7-9bdefd126dd9</code> which are 5 characteristics:</p>
<ul>
<li><b>People Entered So Far</b>: UUID <code>cf88405b-e223-4976-82aa-78c6b305b0a8</code><ul>
<li>[<b>Readable</b>] - Get total number of people enter the room</li>
<li>[<b>Writable</b>] - Clear total number of people enter the room <br  />
</li>
</ul>
</li>
<li><b>People Count</b>: UUID <code>2b9837e1-5560-49e5-a8cf-2f3b0db0bd6b</code><ul>
<li>[<b>Readable</b>] - Get number of people in the room</li>
<li>[<b>Writable</b>] - Clear number of people in the room <br  />
</li>
</ul>
</li>
<li><b>Min Distance</b>: UUID <code>f2f7c459-e623-4970-ab36-d3a4651a694e</code><ul>
<li>[<b>Readable</b>] - Get minimum distance that is using by counting people algorithm (mm)</li>
<li>[<b>Writable</b>] - Set minimum distance that is using by counting people algorithm (mm) <br  />
</li>
</ul>
</li>
<li><b>Max Distance</b>: UUID <code>d0a946d7-a183-4cb7-a9cb-b9c879cdb6fa</code><ul>
<li>[<b>Readable</b>] - Get maximum distance that is using by counting people algorithm (mm)</li>
<li>[<b>Writable</b>] - Set maximum distance that is using by counting people algorithm (mm) <br  />
</li>
</ul>
</li>
<li><b>Distance Threshold</b>: UUID <code>0192bd9d-cb4f-49cc-b3dc-2d7facc9edcd</code><ul>
<li>[<b>Readable</b>] - Get distance threshold that is using by counting people algorithm (mm)</li>
<li>[<b>Writable</b>] - Set distance threshold that is using by counting people algorithm (mm)(mm) <br  />
</li>
</ul>
</li>
<li><b>Timing Budget</b>: UUID <code>01fb0e47-13c9-4369-88cc-07f58759a6a6</code><ul>
<li>[<b>Readable</b>] - Get timing budget that is using by counting people algorithm (ms)</li>
<li>[<b>Writable</b>] - Set timing budget that is using by counting people algorithm (ms) <br  />
</li>
</ul>
</li>
<li><b>Notification Status</b>: UUID <code>ca89196b-76e2-41a0-9e41-342f4a2ff6f1</code><ul>
<li>[<b>Readable</b>] - Get notification status</li>
<li>[<b>Writable</b>] - Enable &amp; disable notification status</li>
</ul>
</li>
<li><b>Room capacity</b>: UUID <code>c714d394-7e0d-4c6a-a864-1183046a244c</code><ul>
<li>[<b>Readable</b>] - Get room capacity</li>
<li>[<b>Writable</b>] - Set room capacity</li>
<li>[<b>Notifiable</b>] - Get notification of room status( full or empty)</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md24"></a>
People Counting Implementation</h2>
<h3><a class="anchor" id="autotoc_md25"></a>
Application initialization</h3>
<p ><img src="doc/images/app_init.png" alt="Application init" class="inline"/> <br  />
</p>
<h3><a class="anchor" id="autotoc_md26"></a>
Sensor initialization</h3>
<p ><img src="doc/images/sensor_init.png" alt="Sensor init" class="inline"/> <br  />
</p>
<h3><a class="anchor" id="autotoc_md27"></a>
Sensor sampling</h3>
<p ><img src="doc/images/sampling_workflows.png" alt="Sensor sampling" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md28"></a>
Application Workflows</h3>
<ol type="1">
<li>Initialize the peripherals, the Bluetooth stack.</li>
<li>Initialize and load the NVM3 configurations</li>
<li>Wait for the VL53L1X sensor is booted and initialize the VL53L1X sensor with the configurations from NVM3:<ul>
<li>Distance mode: LONG</li>
<li>Timing budget: 33 ms</li>
<li>Region of interest SPADs: 8x16 <br  />
</li>
</ul>
</li>
<li>Start ranging for the VL53L1X sensor.</li>
<li>Initialize the OLED display.</li>
<li>Start a periodic timer with period 1ms. The timer callback will fire an external event to ble stack and the event handler will do:<ul>
<li>Check if ranging data is ready.</li>
<li>Get the new distance sample.</li>
<li>Calculate people counting algorithm with new distance sample.</li>
<li>Switch Region of interest( ROI) center to other zone( front or back)</li>
</ul>
</li>
<li>Start a periodic timer with period 1000ms, The timer callback will fire an external event to ble stack and the event handler will display people counting data from the result of the counting algorithm calculation.</li>
<li>After the <em>sl_bt_evt_system_boot_id</em> event arrives, App sets up the security manager to bond with an iOS/Android device. And then start advertising.</li>
<li>Handle GATT event to help user configure the counting algorithm and get the result from the algorithm calculation over the <em>EFR32 connect</em> mobile app</li>
</ol>
<h2><a class="anchor" id="autotoc_md29"></a>
Counting algorithm</h2>
<p >The counting algorithm example relies on a list of states that have to occur in a certain order to detect if a person has crossed the specified area and in which direction this area has been crossed. These states are stored in a list and compared to two default lists of states that represent how the area is crossed in two different directions.</p>
<p >When no-one is seen in either of the two zones, the list of states is reset. If we consider that a person detected in the front zone equals 2, and a person detected in the back zone equals 1, the algorithm adds the value of the two states and stores the result as soon as it changes.</p>
<p >Eventually, if the consecutive states in the list are 0, 1, 3, 2, 0 or 0, 2, 3, 1, 0 this means a person has been detected in one direction or the other, as described in figure below. List of status values.</p>
<p ><img src="doc/images/counting_algorithm.png" alt="Counting Algorithm" class="inline"/> <br  />
</p>
<p >Algorithm workflows</p>
<p ><img src="doc/images/algorithm_workflows.png" alt="Algorithm workflows" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md30"></a>
OLED Display</h2>
<ul>
<li>Display current people count and the value of the entered people so far</li>
</ul>
<h2><a class="anchor" id="autotoc_md31"></a>
Button</h2>
<ul>
<li>Press button to clear current people count</li>
</ul>
<h2><a class="anchor" id="autotoc_md32"></a>
Room status notification</h2>
<ul>
<li>To receive status of room(full or empty), the user need to use the EFR Connect Mobile Application to enable notification</li>
<li>If the number of people count is greater than room capacity then the device will send a "room is full" notification</li>
<li>If the number of people count is zero then the device will send a "room is empty" notification</li>
</ul>
<h2><a class="anchor" id="autotoc_md33"></a>
Reset the counting value</h2>
<ul>
<li>To reset the number of total people entered the room infomation, the user need to use the EFR Connect Mobile Application to write 0 to the <em>People Entered So Far</em> characteristic</li>
<li>To reset the number of people count infomation, the user need to use the EFR Connect Mobile Application to write 0 to the <em>People Count</em> characteristic</li>
</ul>
<h2><a class="anchor" id="autotoc_md34"></a>
Use EFR Connect Mobile Application</h2>
<h3><a class="anchor" id="autotoc_md35"></a>
Connect to the device</h3>
<p >The Silicon Labs EFR Connect application utilizes the Bluetooth adapter on your phone/tablet to scan, connect and interact with BLE devices. To run this example, an iOS or Android smartphone with the EFR Connect app installed is required.</p>
<p >Open the EFR Connect application on your smartphone and allow the permission request when opened for the first time. Click [Develop] -&gt; [Browser] and you will see a list of nearby devices which are sending Bluetooth advertisements. Find the one named <em>People Counting</em> and click the connect button on the right side. If app show the pairing request dialog, press <b>Pair</b> button to confirm authentication for the pairing process. After that, wait for the connection to be established and the GATT database to be loaded.</p>
<p ><b>Note</b>: The pairing process on Android and iOS devices is different. For more information, refer to bluetooth security.</p>
<p >| <img src="doc/images/efr32_connect_app1.png" alt="EFR32 Connect App" class="inline"/> | <img src="doc/images/efr32_connect_app2.png" alt="EFR32 Connect App" class="inline"/>|<img src="doc/images/efr32_connect_app3.png" alt="EFR32 Connect App" class="inline"/>| | - | - | -|</p>
<h3><a class="anchor" id="autotoc_md36"></a>
People entered so far count characteristic</h3>
<ul>
<li>Read to get the current total people entered count</li>
<li>Write <em>00 00</em> to reset total people entered count</li>
</ul>
<p ><img src="doc/images/efr32_connect_app_people_entered_so_far.png" alt="EFR32 Connect App" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md37"></a>
People count characteristic</h3>
<ul>
<li>Read to get the current people count</li>
<li>Write <em>00 00</em> to reset people count</li>
</ul>
<p ><img src="doc/images/efr32_connect_app_people_count.png" alt="EFR32 Connect App" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md38"></a>
Min distance characteristic</h3>
<ul>
<li>Read to get the current minimum distance setting</li>
<li>Write to set minimum distance settings</li>
</ul>
<p ><img src="doc/images/efr32_connect_app_min_distance.png" alt="EFR32 Connect App" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md39"></a>
Max distance characteristic</h3>
<ul>
<li>Read to get the current maximum distance setting</li>
<li>Write to set maximum distance settings</li>
</ul>
<p ><img src="doc/images/efr32_connect_app_max_distance.png" alt="EFR32 Connect App" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md40"></a>
Max distance threshold characteristic</h3>
<ul>
<li>Read to get the current distance threshold setting</li>
<li>Write to set distance threshold setting <br  />
</li>
</ul>
<p ><img src="doc/images/efr32_connect_app_distance_threshold.png" alt="EFR32 Connect App" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md41"></a>
Timing budget characteristic</h3>
<ul>
<li>Read to get the current timing budget setting</li>
<li>Write to set timing budget setting <br  />
</li>
</ul>
<p ><img src="doc/images/efr32_connect_app_timing_budget.png" alt="EFR32 Connect App" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md42"></a>
Notification status characteristic</h3>
<ul>
<li>Read to get the current notification status setting</li>
<li>Write to set notification status setting <br  />
</li>
</ul>
<p ><img src="doc/images/efr32_connect_app_notification_status.png" alt="EFR32 Connect App" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md43"></a>
.sls Projects Used</h1>
<ul>
<li><a href="SimplicityStudio/bluetooth_people_counting.sls">bluetooth_people_counting.sls</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
